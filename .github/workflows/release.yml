name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Optional version override (e.g. 0.5.2)"
        required: false
        default: ""

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.11"

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Resolve version
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrWhiteSpace($version)) {
            if ("${{ github.ref }}" -like "refs/tags/v*") {
              $version = "${{ github.ref_name }}"
            } else {
              $version = python -c "import pathlib,tomllib; print(tomllib.loads(pathlib.Path('pyproject.toml').read_text(encoding='utf-8'))['project']['version'])"
            }
          }
          $version = $version.TrimStart('v')
          "PULSIMGUI_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Release version: $version"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[build]"

      - name: Verify backend dependency
        shell: pwsh
        run: |
          python -c "import pulsim, pulsim._pulsim; print('pulsim backend available:', pulsim.__version__)"

      - name: Build package
        shell: pwsh
        run: python scripts/build.py --platform windows --no-installer

      - name: Smoke test executable startup
        shell: pwsh
        run: |
          if (-not (Test-Path "dist\\PulsimGui.exe")) {
            throw "Missing dist\\PulsimGui.exe"
          }
          $proc = Start-Process -FilePath "dist\\PulsimGui.exe" -PassThru
          Start-Sleep -Seconds 5
          if ($proc.HasExited) {
            throw "PulsimGui.exe exited during startup smoke test (exit code: $($proc.ExitCode))."
          }
          Stop-Process -Id $proc.Id -Force

      - name: Create portable zip
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\\PulsimGui.exe" -DestinationPath "dist\\PulsimGui-$env:PULSIMGUI_VERSION-windows-x64.zip" -Force

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          if-no-files-found: error
          path: |
            dist/PulsimGui.exe
            dist/*-windows-x64.zip

  build-windows-installer:
    name: Build Windows Installer
    runs-on: windows-latest
    permissions:
      contents: read
    needs: build-windows
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download Windows build
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: dist

      - name: Resolve version
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          if ([string]::IsNullOrWhiteSpace($version)) {
            if ("${{ github.ref }}" -like "refs/tags/v*") {
              $version = "${{ github.ref_name }}"
            } else {
              $version = python -c "import pathlib,tomllib; print(tomllib.loads(pathlib.Path('pyproject.toml').read_text(encoding='utf-8'))['project']['version'])"
            }
          }
          $version = $version.TrimStart('v')
          "PULSIMGUI_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Release version: $version"

      - name: Ensure Windows installer icon
        shell: pwsh
        run: |
          $icoPath = Join-Path $PWD "packaging/icons/pulsimgui.ico"
          if (Test-Path -LiteralPath $icoPath) {
            Write-Host "Installer icon already exists: $icoPath"
            exit 0
          }
          $pngPath = Join-Path $PWD "packaging/icons/pulsimgui.png"
          if (-not (Test-Path -LiteralPath $pngPath)) {
            throw "Missing source icon at $pngPath"
          }
          Add-Type -AssemblyName System.Drawing
          $bitmap = [System.Drawing.Bitmap]::FromFile($pngPath)
          try {
            $icon = [System.Drawing.Icon]::FromHandle($bitmap.GetHicon())
            try {
              $stream = [System.IO.File]::Create($icoPath)
              try {
                $icon.Save($stream)
              } finally {
                $stream.Dispose()
              }
            } finally {
              $icon.Dispose()
            }
          } finally {
            $bitmap.Dispose()
          }
          if (-not (Test-Path -LiteralPath $icoPath)) {
            throw "Failed to generate installer icon at $icoPath"
          }
          Write-Host "Generated installer icon: $icoPath"

      - name: Install NSIS
        shell: pwsh
        run: choco install nsis -y --no-progress

      - name: Build installer
        shell: pwsh
        run: |
          (Get-Content packaging/windows/installer.nsi) -replace '!define APP_VERSION ".*"', "!define APP_VERSION `"$env:PULSIMGUI_VERSION`"" | Set-Content packaging/windows/installer.nsi
          $makensis = $null
          $cmd = Get-Command makensis -ErrorAction SilentlyContinue
          if ($cmd -and $cmd.Path -and (Test-Path -LiteralPath $cmd.Path)) {
            $makensis = $cmd.Path
          }
          if (-not $makensis) {
            foreach ($candidate in @(
              "$env:ChocolateyInstall\bin\makensis.exe",
              "${env:ProgramFiles(x86)}\NSIS\makensis.exe",
              "$env:ProgramFiles\NSIS\makensis.exe"
            )) {
              if ($candidate -and (Test-Path -LiteralPath $candidate)) {
                $makensis = $candidate
                break
              }
            }
          }
          if (-not $makensis) {
            throw "makensis.exe not found after NSIS installation"
          }
          Write-Host "Using makensis at: $makensis"
          & $makensis packaging/windows/installer.nsi
          if ($LASTEXITCODE -ne 0) {
            throw "NSIS build failed with exit code $LASTEXITCODE"
          }
          $installer = Get-ChildItem -Path packaging/windows -Filter "PulsimGui-*-setup.exe" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $installer) {
            throw "NSIS did not generate installer output"
          }
          Move-Item $installer.FullName "dist/$($installer.Name)" -Force

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          if-no-files-found: error
          path: dist/PulsimGui-*-setup.exe

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Resolve version
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
              VERSION="${GITHUB_REF_NAME#v}"
            else
              VERSION="$(python -c "import pathlib,tomllib; print(tomllib.loads(pathlib.Path('pyproject.toml').read_text(encoding='utf-8'))['project']['version'])")"
            fi
          fi
          VERSION="${VERSION#v}"
          echo "PULSIMGUI_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Release version: $VERSION"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[build]"

      - name: Verify backend dependency
        shell: bash
        run: |
          python - <<'PY'
          import pulsim
          import pulsim._pulsim
          print("pulsim backend available:", pulsim.__version__)
          PY

      - name: Build package
        shell: bash
        run: python scripts/build.py --platform macos

      - name: Audit macOS bundle completeness
        shell: bash
        run: |
          test -f "dist/PulsimGui.app/Contents/MacOS/PulsimGui"
          test -f "dist/PulsimGui-${PULSIMGUI_VERSION}-macos.dmg"
          find "dist/PulsimGui.app" -name '_pulsim*' | grep -q .
          find "dist/PulsimGui.app" -path '*platforms/libqcocoa*' | grep -q .
          if otool -L "dist/PulsimGui.app/Contents/MacOS/PulsimGui" | grep -E '/opt/homebrew|/usr/local'; then
            echo "Found non-system linkage to host-specific paths in app bundle"
            exit 1
          fi

      - name: Package app bundle as zip
        shell: bash
        run: |
          if [ -d "dist/PulsimGui.app" ]; then
            ditto -c -k --sequesterRsrc --keepParent \
              "dist/PulsimGui.app" \
              "dist/PulsimGui-${PULSIMGUI_VERSION}-macos-app.zip"
          fi

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          if-no-files-found: error
          path: |
            dist/*.dmg
            dist/*-macos-app.zip

  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Resolve version
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
              VERSION="${GITHUB_REF_NAME#v}"
            else
              VERSION="$(python -c "import pathlib,tomllib; print(tomllib.loads(pathlib.Path('pyproject.toml').read_text(encoding='utf-8'))['project']['version'])")"
            fi
          fi
          VERSION="${VERSION#v}"
          echo "PULSIMGUI_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Release version: $VERSION"

      - name: Install system dependencies for build host
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1 \
            libegl1 \
            libxkbcommon0 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xfixes0 \
            libxcb-xinput0 \
            libfontconfig1 \
            libfreetype6 \
            libx11-xcb1 \
            libdbus-1-3 \
            fuse \
            libfuse2

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[build]"

      - name: Verify backend dependency
        shell: bash
        run: |
          python - <<'PY'
          import pulsim
          import pulsim._pulsim
          print("pulsim backend available:", pulsim.__version__)
          PY

      - name: Build package
        shell: bash
        run: python scripts/build.py --platform linux

      - name: Audit Linux binary and AppImage
        shell: bash
        run: |
          test -f dist/pulsimgui
          if ldd dist/pulsimgui | grep -q "not found"; then
            echo "Missing shared libraries in Linux binary"
            ldd dist/pulsimgui
            exit 1
          fi
          APPIMAGE="$(ls -1 dist/PulsimGui-*-x86_64.AppImage | head -n 1)"
          test -n "$APPIMAGE"
          chmod +x "$APPIMAGE"
          "$APPIMAGE" --appimage-version

      - name: Create portable tarball
        shell: bash
        run: |
          if [ -f "dist/pulsimgui" ]; then
            tar -C dist -czf "dist/PulsimGui-${PULSIMGUI_VERSION}-linux-x64.tar.gz" pulsimgui
          fi

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          if-no-files-found: error
          path: |
            dist/*.AppImage
            dist/*-linux-x64.tar.gz
            dist/pulsimgui

  release:
    name: Create GitHub Release
    needs: [build-windows, build-windows-installer, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Resolve version
        id: version
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
              VERSION="${GITHUB_REF_NAME#v}"
            else
              VERSION="$(python -c "import pathlib,tomllib; print(tomllib.loads(pathlib.Path('pyproject.toml').read_text(encoding='utf-8'))['project']['version'])")"
            fi
          fi
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        shell: bash
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.exe" -o -name "*.tar.gz" \) -exec cp {} release/ \;
          ls -lah release
          count=$(find release -type f | wc -l | tr -d ' ')
          if [ "$count" = "0" ]; then
            echo "No release artifacts were generated."
            exit 1
          fi

      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          target_commitish: ${{ github.sha }}
          name: PulsimGui v${{ steps.version.outputs.version }}
          draft: false
          generate_release_notes: true
          files: release/*
          body: |
            Cross-platform packages for PulsimGui with bundled backend/runtime dependencies.

            Included artifacts:
            - Windows: portable `PulsimGui.exe`, zip, and installer
            - macOS: `.dmg` installer and `.app` zip
            - Linux: `.AppImage` and portable tarball

  publish-pypi:
    name: Publish to PyPI
    needs: [release]
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/v') }}
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Sync project version with release tag
        shell: bash
        run: |
          python - <<'PY'
          from pathlib import Path
          import os
          import re
          import tomllib

          tag_version = os.environ["GITHUB_REF_NAME"].removeprefix("v")
          pyproject_path = Path("pyproject.toml")
          content = pyproject_path.read_text(encoding="utf-8")

          project_version = tomllib.loads(content)["project"]["version"]
          print(f"Tag version: {tag_version}")
          print(f"Project version (before sync): {project_version}")

          if project_version == tag_version:
              print("Project version already matches tag.")
              raise SystemExit(0)

          # Update only the [project] version field.
          pattern = re.compile(
              r'(^\[project\]\n(?:.*?\n)*?^version\s*=\s*")([^"]+)(")',
              re.MULTILINE | re.DOTALL,
          )
          match = pattern.search(content)
          if not match:
              raise RuntimeError("Could not find [project].version in pyproject.toml")

          updated = pattern.sub(
              lambda m: f'{m.group(1)}{tag_version}{m.group(3)}',
              content,
              count=1,
          )
          pyproject_path.write_text(updated, encoding="utf-8")
          print(f"Updated pyproject version to: {tag_version}")
          PY

      - name: Build sdist and wheel
        shell: bash
        run: |
          python -m pip install --upgrade pip build
          python -m build
          ls -lah dist

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
